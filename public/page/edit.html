<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chỉnh sửa sản phẩm</title>
    <link rel="stylesheet" href="../styles/edit.css">
</head>
<body>
    <header>
        <div class="logo"><a href="/">LOGO</a></div>
    </header>

    <div class="container">
        <aside class="sidebar">
            <h2>Quản lý sản phẩm</h2>
            <ul>
                <li><a href="/add.html">Thêm sản phẩm</a></li>
                <li><a href="/display.html">Danh sách sản phẩm</a></li>
            </ul>
        </aside>

        <main class="content">
            <h2>Cập nhật sản phẩm</h2>
            <form id="editForm" enctype="multipart/form-data">
                <label for="editId">Mã sản phẩm:</label>
                <input type="text" id="editId" disabled>

                <label for="editName">Tên sản phẩm:</label>
                <input type="text" id="editName" required>

                <label for="editCategory">Loại sản phẩm:</label>
                <input type="text" id="editCategory" required>
                
                <label for="editImage">Hình ảnh (nếu thay đổi):</label>
                <input type="file" id="editImage" accept="image/*">

                <button type="submit">Lưu</button>
            </form>
        </main>
    </div>

    <script>
    const urlParams = new URLSearchParams(window.location.search);
    const productId = urlParams.get("id");

    if (!productId) {
        alert("Không tìm thấy sản phẩm!");
        window.location.href = "display.html";
    }

    // Load dữ liệu sản phẩm từ MongoDB
    document.addEventListener("DOMContentLoaded", () => {
        fetch(`/api/sanpham/${productId}`)
            .then(response => {
                if (!response.ok) throw new Error("Không tìm thấy sản phẩm");
                return response.json();
            })
            .then(sanpham => {
                document.getElementById("editId").value = sanpham._id;
                document.getElementById("editName").value = sanpham.tensanpham;
                document.getElementById("editCategory").value = sanpham.loaisanpham;
            })
            .catch(error => {
                console.error("Lỗi khi tải sản phẩm:", error);
                alert("Lỗi khi tải sản phẩm");
                window.location.href = "display.html";
            });
    });

    // Submit form cập nhật
    document.getElementById("editForm").addEventListener("submit", (event) => {
        event.preventDefault();

        const formData = new FormData();
        formData.append("tensanpham", document.getElementById("editName").value);
        formData.append("loaisanpham", document.getElementById("editCategory").value);

        const imageFile = document.getElementById("editImage").files[0];
        if (imageFile) {
            formData.append("hinhanh", imageFile);
        }

        fetch(`/api/sanpham/${productId}`, {
            method: "PUT",
            body: formData
        })
        .then(response => {
            if (!response.ok) throw new Error("Lỗi khi cập nhật sản phẩm");
            return response.json();
        })
        .then(data => {
            alert("Cập nhật thành công!");
            window.location.href = "display.html";
        })
        .catch(error => {
            console.error("Lỗi khi cập nhật sản phẩm:", error);
            alert("Không thể cập nhật sản phẩm.");
        });
    });
    </script>
</body>
</html>
